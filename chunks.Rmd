---
title: "Desigualdades"
author: "Lucía Bartolomeu"
date: "2023-01-05"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 2
editor_options:
  chunk_output_type: inline
---
# Resumen
Este informe fue realizado con el objetivo bla bla...

# Indicadores

Para calcular los indicadores, en primer lugar instalamos los paquetes y activamos las librerías que vamos a utilizar.

```{r pack y library, include=FALSE}
#paquetes y librerías
#instalar paquetes
#install.packages("tidyverse")
#install.packages("readxl")
#install.packages("writexl")
#install.packages("ggplot2")
#install.packages("rlang")

#activar librerías
library(tidyverse)
library(lubridate)
library(readxl)
library(writexl)
library(ggplot2)
library(rlang)
library(knitr)
library(DT)
library(ggpubr)
library(gt)
library(gtExtras)
library(svglite)
```

# Razón de mortalidad materna

- Se calcula como: Muertes maternas por provincia/ nacidos vivos por provincia *fac de expansión. 
- Fuentes: nacidos vivos y registros de defunciones. 
- Indicador construido para 2019 y 2020, construido por quinquenios (2015 a 2019 y 2016 a 2020)

### Comenzamos por calcular las muertes maternas

```{r muertes maternas, echo=TRUE}
#muertes maternas por provincia
#traer base mortalidad
base_mortalidad <- read.csv2("MINSAL-defunciones-2005-2020.csv", encoding="latin1", sep = ",")

#mirar variables
datatable(head(base_mortalidad),caption = "This is the table caption")
datatable(str(base_mortalidad))
kable(table(base_mortalidad$sexo_id))
kable(table(base_mortalidad$muerte_materna_clasificacion))

#incluir muerte materna tardía?
#descriptivo quinquenios
base_mortalidad_materna_quinquenios <- base_mortalidad %>% 
  filter(muerte_materna_clasificacion == "muerte materna" |  
         muerte_materna_clasificacion == "muerte materna tardia") %>% 
  mutate(quinquenio = case_when(
               between(anio, 2006,2010)~ "2006 - 2010",
                      between(anio, 2011,2015)~ "2011 - 2015",
                      between(anio, 2016,2020)~ "2016 - 2020",
                      TRUE~ NA_character_
                                          )) %>% 
                    filter(!is.na(quinquenio)) %>% 
    group_by(quinquenio,jurisdicion_residencia_nombre) %>% 
  summarise(suma_quinquenio= sum(cantidad),mean=suma_quinquenio/5) %>% ###cambie la forma de clacular el promedio, si no se entendio preguntame
  ungroup()

datatable(base_mortalidad_materna_quinquenios)
```

Se presenta un gráfico descriptivo del número de muertes maternas según quinquenio por provincia.  

```{r muertes maternas graf1, echo=TRUE, fig.height=7, fig.width=8}
base_mortalidad_materna_quinquenios$quinquenio <- factor(base_mortalidad_materna_quinquenios$quinquenio, 
                                                          levels= c("2006 - 2010", "2011 - 2015", "2016 - 2020"))

ggplot(filter(base_mortalidad_materna_quinquenios,!is.na(jurisdicion_residencia_nombre),
                                                         jurisdicion_residencia_nombre!="Sin Información"),
       aes(quinquenio, suma_quinquenio, group=1))+
  geom_line(color = "steelblue",size = 1) +
  geom_point(color="steelblue") + 
  facet_wrap(~ jurisdicion_residencia_nombre,scales="free",ncol=5)+
  theme_test()+
  theme(
    axis.text.x = element_text(size=5)
  )
```
  
  
```{r muertes_maternas_q1519, echo=TRUE}
#quinquenio 2015-2019
base_mortalidad_materna_1519 <- base_mortalidad %>% 
  filter(muerte_materna_clasificacion == "muerte materna" |  
         muerte_materna_clasificacion == "muerte materna tardia") %>% 
  mutate(quinquenio = case_when(
               between(anio, 2015,2019)~ "2015 - 2019",
                     TRUE~ NA_character_)) %>% 
  filter(!is.na(quinquenio)) %>% 
    group_by(quinquenio,jurisdicion_residencia_nombre) %>% 
  summarise(suma_quinquenio= sum(cantidad),mean=suma_quinquenio/5) %>% 
  filter(jurisdicion_residencia_nombre!="Sin Información",!is.na(jurisdicion_residencia_nombre))

base_mortalidad_materna_1519_tot <- base_mortalidad %>% 
  filter(muerte_materna_clasificacion == "muerte materna" |  
         muerte_materna_clasificacion == "muerte materna tardia") %>% 
  mutate(quinquenio = case_when(
               between(anio, 2015,2019)~ "2015 - 2019",
                     TRUE~ NA_character_)) %>% 
  filter(!is.na(quinquenio)) %>% 
    group_by(quinquenio) %>% 
  summarise(suma_quinquenio= sum(cantidad),mean=suma_quinquenio/5) 

base_mortalidad_materna_1519_tot$jurisdicion_residencia_nombre <- "Total pais"
base_mortalidad_materna_1519_tot <- select(base_mortalidad_materna_1519_tot,"quinquenio" , "jurisdicion_residencia_nombre","suma_quinquenio","mean")

base_mortalidad_materna_1519 <- rbind(base_mortalidad_materna_1519,base_mortalidad_materna_1519_tot)

datatable(base_mortalidad_materna_1519, caption = "Promedio de muertes maternas en quinquenio 15-19 por provincias")

```

```{r muertes_maternas_q1620, echo=TRUE}  

#quinquenio 2016-2020
base_mortalidad_materna_1620 <- base_mortalidad %>% 
  filter(muerte_materna_clasificacion == "muerte materna" |  
         muerte_materna_clasificacion == "muerte materna tardia") %>% 
  mutate(quinquenio = case_when(
               between(anio, 2016,2020)~ "2016 - 2020",
                     FALSE~ NA_character_
                                          )) %>% 
                    filter(!is.na(quinquenio)) %>% 
    group_by(quinquenio,jurisdicion_residencia_nombre) %>% 
  summarise(suma_quinquenio= sum(cantidad),mean=suma_quinquenio/5) %>% 
   filter(jurisdicion_residencia_nombre!="Sin Información",!is.na(jurisdicion_residencia_nombre))

base_mortalidad_materna_1620_tot <- base_mortalidad %>% 
  filter(muerte_materna_clasificacion == "muerte materna" |  
         muerte_materna_clasificacion == "muerte materna tardia") %>% 
  mutate(quinquenio = case_when(
               between(anio, 2015,2019)~ "2015 - 2019",
                     TRUE~ NA_character_)) %>% 
  filter(!is.na(quinquenio)) %>% 
    group_by(quinquenio) %>% 
  summarise(suma_quinquenio= sum(cantidad),mean=suma_quinquenio/5) 

base_mortalidad_materna_1620_tot$jurisdicion_residencia_nombre <- "Total pais"
base_mortalidad_materna_1620_tot <- select(base_mortalidad_materna_1620_tot,"quinquenio" , "jurisdicion_residencia_nombre","suma_quinquenio","mean")

base_mortalidad_materna_1620 <- rbind(base_mortalidad_materna_1620,base_mortalidad_materna_1519_tot)

datatable(base_mortalidad_materna_1620, caption = "Promedio de muertes maternas en quinquenio 16-20 por provincias")

```

Luego se calculan los nacidos vivos, mismo período o jurisdicciones

```{r nacidos vivos,echo=TRUE}
#nacidos vivos por provincia
#traer base nacidos vivos
base_nacidos_vivos <- read.csv2("MINSAL - Nacidos vivos 2005-2020 jurisdicción residencia de la madre.csv", encoding="latin1", sep = ",")

#mirar variables
#str(base_nacidos_vivos)

#descriptivo quinquenios
base_nacidos_vivos_quinquenios <- base_nacidos_vivos %>% 
  mutate(quinquenio = case_when(
               between(anio, 2006,2010)~ "2006 - 2010",
                      between(anio, 2011,2015)~ "2011 - 2015",
                      between(anio, 2016,2020)~ "2016 - 2020",
                      FALSE~ NA_character_
                                          )) %>% 
                    filter(!is.na(quinquenio)) %>% 
    group_by(quinquenio,jurisdicion_residencia_nombre) %>% 
  summarise(suma_quinquenio= sum(nacimientos_cantidad),mean=suma_quinquenio/5) %>% 
   filter(jurisdicion_residencia_nombre!="Sin Información",!is.na(jurisdicion_residencia_nombre)) %>% 
  ungroup(quinquenio)


#quinquenio 2015-2019
base_nacidos_vivos_1519 <- base_nacidos_vivos %>% 
  mutate(quinquenio = case_when(
               between(anio, 2015,2019)~ "2015 - 2019",
                     FALSE~ NA_character_
                                          )) %>% 
                    filter(!is.na(quinquenio)) %>% 
    group_by(quinquenio,jurisdicion_residencia_nombre) %>% 
  summarise(suma_quinquenio= sum(nacimientos_cantidad),mean=suma_quinquenio/5) %>% 
   filter(jurisdicion_residencia_nombre!="Sin Información",!is.na(jurisdicion_residencia_nombre)) %>% 
  ungroup(quinquenio)

#agregto to pais

base_nacidos_vivos_1519_tot <- base_nacidos_vivos %>% 
  mutate(quinquenio = case_when(
               between(anio, 2015,2019)~ "2015 - 2019",
                     FALSE~ NA_character_
                                          )) %>% 
                    filter(!is.na(quinquenio)) %>% 
    group_by(quinquenio) %>% 
  summarise(suma_quinquenio= sum(nacimientos_cantidad),mean=suma_quinquenio/5) %>% 
  mutate(jurisdicion_residencia_nombre="Total pais") %>% 
  select("quinquenio", "jurisdicion_residencia_nombre", "suma_quinquenio","mean")

base_nacidos_vivos_1519 <- rbind(base_nacidos_vivos_1519,base_nacidos_vivos_1519_tot)

#quinquenio 2016-2020
base_nacidos_vivos_1620 <- base_nacidos_vivos %>% 
  mutate(quinquenio = case_when(
               between(anio, 2016,2020)~ "2016 - 2020",
                     FALSE~ NA_character_
                                          )) %>% 
                    filter(!is.na(quinquenio)) %>% 
    group_by(quinquenio,jurisdicion_residencia_nombre) %>% 
  summarise(suma_quinquenio= sum(nacimientos_cantidad),mean=suma_quinquenio/5) %>% 
   filter(jurisdicion_residencia_nombre!="Sin Información",!is.na(jurisdicion_residencia_nombre)) %>% 
  ungroup(quinquenio)
#agregto to pais

base_nacidos_vivos_1620_tot <- base_nacidos_vivos %>% 
  mutate(quinquenio = case_when(
               between(anio, 2015,2019)~ "2015 - 2019",
                     FALSE~ NA_character_
                                          )) %>% 
                    filter(!is.na(quinquenio)) %>% 
    group_by(quinquenio) %>% 
  summarise(suma_quinquenio= sum(nacimientos_cantidad),mean=suma_quinquenio/5) %>% 
  mutate(jurisdicion_residencia_nombre="Total pais") %>% 
  select("quinquenio", "jurisdicion_residencia_nombre", "suma_quinquenio","mean")

base_nacidos_vivos_1620 <- rbind(base_nacidos_vivos_1620,base_nacidos_vivos_1620_tot)

```

### Finalmente, calculo la razón de mortalidad materna

```{r RMM, echo=TRUE}
###razón de mortalidad materna utilizando suma de nacidos vivos como denominador de suma de mm y promedio con promedio

#AÑO 2019
unidos_2019 <- left_join(base_mortalidad_materna_1519, base_nacidos_vivos_1519, 
              by = c("jurisdicion_residencia_nombre" = "jurisdicion_residencia_nombre", "quinquenio" = "quinquenio"))

unidos_2020 <- left_join(base_mortalidad_materna_1620, base_nacidos_vivos_1620, 
              by = c("jurisdicion_residencia_nombre" = "jurisdicion_residencia_nombre", "quinquenio" = "quinquenio"))

RMM_2019 <- unidos_2019 %>% 
  mutate(RMM_suma_19 = round(suma_quinquenio.x/suma_quinquenio.y*100000,1)) %>% 
  mutate(RMM_mean_19 = mean.x/mean.y*100000) %>% 
  ungroup(quinquenio)


datatable(select(RMM_2019,"jurisdicion_residencia_nombre" ,"RMM_suma_19"),caption = "RMM por provincia, año 2019")

RMM_2020 <- unidos_2020%>% 
  mutate(RMM_suma_20 = round(suma_quinquenio.x/suma_quinquenio.y*100000,1)) %>% 
  mutate(RMM_mean_20 = mean.x/mean.y*100000) %>% 
  ungroup(quinquenio)

datatable(select(RMM_2020,"jurisdicion_residencia_nombre" ,"RMM_suma_20"),caption = "RMM por provincia, año 2020")

write_xlsx(RMM_2019,"RMM2019.xlsx")
write_xlsx(RMM_2020,"RMM2020.xlsx")

```

```{r graficos rmm, echo=TRUE, fig.height=10, fig.width=12}


#bar plot
plot1 <- RMM_2019 %>% mutate(
    color = case_when(
      row_number() == 25 ~ "coral2",
      ## all others should be gray
      TRUE ~ "gray70"
    ) ) %>%
   ggplot(aes(x = RMM_mean_19, y = fct_reorder(jurisdicion_residencia_nombre,RMM_mean_19), fill = color)) +
  geom_col() +
  geom_text(
    aes(label = round(RMM_mean_19,1)), 
    hjust = 1, nudge_x = -.5,
    size = 4, fontface = "bold" ) +
  ## reduce spacing between labels and bars
  scale_x_continuous(expand = c(.02, .02)) +
  scale_fill_identity(guide = "none") +
  labs(title = "RMM por provincia, quinquenio 2015-2019.")+
  ## get rid of all elements except y axis labels + adjust plot margin
  theme_void() +
  theme(axis.text.y = element_text(size = 10, hjust = 1),
        plot.title = element_text(hjust = 0.1),
        plot.margin = margin(rep(15, 4)))

#bar plor a este grafco hacerlo con la tasa

plot2 <-  RMM_2020 %>% mutate(
    color = case_when(
      jurisdicion_residencia_nombre == "Total pais" ~ "coral2",
      ## all others should be gray
      TRUE ~ "gray70"
    ) ) %>%
   ggplot(aes(x = RMM_mean_20, y = fct_reorder(jurisdicion_residencia_nombre,RMM_mean_20), fill = color)) +
  geom_col() +
  geom_text(
    aes(label = round(RMM_mean_20,1)), 
    hjust = 1, nudge_x = -.5,
    size = 4, fontface = "bold" ) +
  ## reduce spacing between labels and bars
  scale_x_continuous(expand = c(.02, .02)) +
  scale_fill_identity(guide = "none") +
  labs(title = "RMM por provincia, quinquenio 2016-2020.")+
  ## get rid of all elements except y axis labels + adjust plot margin
  theme_void() +
  theme(axis.text.y = element_text(size = 10, hjust = 1),
        plot.title = element_text(hjust = 0.1),
        plot.margin = margin(rep(15, 4)))

ggarrange(plot1, plot2,  
          labels = c("A", "B"),
          ncol = 2, nrow = 2)

```


# % de nacidos vivos con bajo peso al nacer:
- Se calcula como: Número de nacidos vivos con bajo peso de un año y prov/numero total de nacidos vivos de un año y prov.
- Fuentes: base nacidos vivos
- Indicador construido para 2019 y 2020

1) Se realizó el cálculo de cantidad de niños con bajo peso al nacer y la cantidad de niños sin bajo peso al nacer

```{r bajo peso al nacer, , echo=TRUE}
base_nacidos_vivos <- read.csv2("MINSAL - Nacidos vivos 2005-2020 jurisdicción residencia de la madre.csv", encoding="latin1", sep = ",")

#mirar variables
str(base_nacidos_vivos)
unique(base_nacidos_vivos$intervalo_peso_al_nacer)

indicador_bajopesoalnacer <- base_nacidos_vivos %>% 
  mutate(bp = case_when(
    intervalo_peso_al_nacer == "1.Menor de 500" | 
      intervalo_peso_al_nacer == "2.500 a 999"  | 
      intervalo_peso_al_nacer == "3.1000 a 1499" |
      intervalo_peso_al_nacer ==  "4.1500 a 1999" |
      intervalo_peso_al_nacer ==  "5.2000 a 2499" ~ "si", 
      TRUE~ "no")) %>% 
  dplyr::filter(anio == "2019" | anio == "2020") %>% 
  select(anio, jurisdicion_residencia_nombre, nacimientos_cantidad, bp) %>%
  group_by(anio, jurisdicion_residencia_nombre, bp) %>% 
  dplyr::summarise(casos=sum(nacimientos_cantidad)) %>% 
  pivot_wider(names_from = bp, values_from = casos) %>% 
  mutate(indicador = round(si/(no+si)*100,2))

datatable(filter(indicador_bajopesoalnacer, !is.na(jurisdicion_residencia_nombre)),
          filter = 'top',
          elementId = NULL,
          options = list(
  searching = FALSE,
  pageLength = 5,
  lengthMenu = c(5, 10, 15, 20)
)
          
          )
write_xlsx(indicador_bajopesoalnacer,"indicador_bajopesoalnacer.xlsx")

```

# Tasa de mortalidad infantil

```{r , echo=TRUE}

db_mort_infantil <- read.csv("tasa-mortalidad-infantil-deis-1990-2020.csv", sep=";")
names(db_mort_infantil)
class(db_mort_infantil$indice_tiempo)
db_mort_infantil$indice_tiempo <- dmy(db_mort_infantil$indice_tiempo)
class(db_mort_infantil$indice_tiempo)
db_mort_infantil2 <- db_mort_infantil %>%
                    mutate(ano=year(indice_tiempo)) %>% 
                    gather(key = "provincia", value = "mort_infantil",2:26) %>% 
                    mutate(trienio= case_when(
                      between(ano, 2015,2017)~ "2015 - 2017",
                      between(ano, 2018,2020)~ "2018 - 2020",
                      between(ano, 2012,2014)~ "2012 - 2014",
                      FALSE~ NA_character_
                                          )) %>% 
  
                    filter(!is.na(trienio)) %>% 
  
  group_by(trienio,provincia ) %>% 
  summarise(promedio= round(mean(mort_infantil),2)) %>% 
  ungroup()


###grafico tendencia

db_mort_infantil %>%
                    mutate(ano=year(indice_tiempo)) %>% 
                    gather(key = "provincia", value = "mort_infantil",2:26) %>% 
                    mutate(trienio= case_when(
                      between(ano, 2015,2017)~ "2015 - 2017",
                      between(ano, 2018,2020)~ "2018 - 2020",
                      between(ano, 2012,2014)~ "2012 - 2014",
                      FALSE~ NA_character_
                                          )) %>% 
                    filter(!is.na(trienio)) %>% 
  mutate(provincia=str_to_upper(str_remove(provincia,"mortalidad_infantil_"))) %>% 
  ggplot(aes(ano, mort_infantil, group=1))+
  geom_line(color = "steelblue",size = 1) +
  geom_point(color="steelblue") + 
  facet_wrap(~ provincia,scales="free",ncol=5)+
  theme_test()+
  theme(
    axis.text.x = element_text(size=5)
  )


datatable(filter(db_mort_infantil2, !is.na(provincia)),
          filter = 'top',
          elementId = NULL,
          options = list(
  searching = FALSE,
   searchHighlight = TRUE,
  pageLength = 5,
  lengthMenu = c(5, 10, 15, 20)))


### TABLA CON MINIGRAF

sparkline <- "black"
final_value <- "black"
range_low <- "green"
range_high <- "red"
type <- "lightgrey"

spkl_palette <- c(sparkline, final_value, range_low, range_high, type)
a <- db_mort_infantil2 %>% 
  
  #arrange(porcent) %>% 
  #spread(ano,porcent) %>% 
  #arrange(desc(`2019`)) %>% 
  # must end up with list of data for each row in the input dataframe
  group_by(provincia) %>% 
  dplyr::summarize(
 
    `2012 - 2014`=promedio[trienio=="2012 - 2014"],
    `2015 - 2017`=promedio[trienio=="2015 - 2017"],
    `2018 - 2020`=promedio[trienio=="2018 - 2020"],
   
                   tendencia = list(promedio), .groups = "drop") %>%
  arrange(desc(`2018 - 2020`)) %>% 
  select(-`2015 - 2017`) %>% 
  gt() %>% 
  gt_plt_sparkline(tendencia, palette = spkl_palette) %>% 
  tab_spanner(
    label = "trienio",
    columns = 2:4
  ) %>% 
  tab_header(
    title = "Mortalidad infantil c xx nacidos vivos",
    subtitle = "Por provincia periodo 2012-2020"
  ) %>% 
  tab_options(
    heading.subtitle.font.size = 12,
    heading.align = "left",
    table.border.top.color = "black",
    column_labels.border.bottom.color = "black",
    column_labels.border.bottom.width= px(3)
  ) %>% 
    gt_highlight_rows(
      rows =11, 
      fill = "lightgrey",
      bold_target_only = TRUE,
      target_col = provincia
    )

a## a esta tabla se le puede mejorar el nombre de las prov 
#gt::gtsave(a, file = "temp.png")

```
 

# Tasa de fecundidad adolescente

- Se calcula como: número de nacimientos de madres de x a x años, prov y año/ población proyectada a mitad de periodo de x a x años , mismo año y provincia
- fuente:base nacidos vivos y base proyecciones poblacionales indec
- Indicador construido para 2019 y 2020

1) primero se calcula el número de nacidos vivos pra cada grupo etario de madres
la base de nacidos vivos agrupa a todas las madres menores de 15 años. Consideramos que las menores de 15 años incluye aprox a partir de 10 años (por una cuestión de desarrollo biológico), por lo tanto utilizamos como numerador menores de 15 años junto con el denominador poblacional de 10 a 15 años.
```{r nacidos vivos x grupo etario madre, echo=TRUE}

base_nacidos_vivos <- read.csv2("MINSAL - Nacidos vivos 2005-2020 jurisdicción residencia de la madre.csv", encoding="latin1", sep = ",")

#mirar variables
str(base_nacidos_vivos)
unique(base_nacidos_vivos$edad_madre_grupo)

#la base de nacidos vivos agrupa a todas las madres menores de 15 años. Consideramos que las menores de 15 años incluye aprox a partir de 10 años (por una cuestión de desarrollo biológico), por lo tanto utilizamos como numerador menores de 15 años junto con el denominador poblacional de 10 a 15 años.
#unique(base_nacidos_vivos$anio)

base_nacidos_vivos_2019 <- base_nacidos_vivos %>%
  filter(anio == "2019")

base_nacidos_vivos_2020 <- base_nacidos_vivos %>%
  filter(anio == "2020")

###AÑO 2019

base_nacidos_vivos_2019_menor15 <- base_nacidos_vivos_2019 %>%
  filter(edad_madre_grupo == "1.Menor de 15") #la base de nacidos vivos agrupa a todas las madres menores de 15 años, no podemos tomar a partir de 10 años ver tema de qué denominador usaríamos)

#unique(base_nacidos_vivos_2019_menor15$edad_madre_grupo)
  
base_nacidos_vivos_2019_15a19 <- base_nacidos_vivos_2019 %>%
  filter(edad_madre_grupo == "2.15 a 19")
  
base_nacidos_vivos_2019_20a24 <- base_nacidos_vivos_2019 %>%
  filter(edad_madre_grupo == "3.20 a 24")
  
base_nacidos_vivos_2019_25a29 <- base_nacidos_vivos_2019 %>%
  filter(edad_madre_grupo == "4.25 a 29")

  
nacidosvivos_2019_menor15_suma <-base_nacidos_vivos_2019_menor15 %>%
  group_by(jurisdicion_residencia_nombre) %>%
  dplyr::summarise(casos=sum(nacimientos_cantidad))

nacidosvivos_2019_15a19_suma <-base_nacidos_vivos_2019_15a19 %>%
  group_by(jurisdicion_residencia_nombre) %>%
  dplyr::summarise(casos=sum(nacimientos_cantidad))

nacidosvivos_2019_20a24_suma <-base_nacidos_vivos_2019_20a24 %>%
  group_by(jurisdicion_residencia_nombre) %>%
  dplyr::summarise(casos=sum(nacimientos_cantidad))

nacidosvivos_2019_25a29_suma <-base_nacidos_vivos_2019_25a29 %>%
  group_by(jurisdicion_residencia_nombre) %>%
  dplyr::summarise(casos=sum(nacimientos_cantidad))

##replico con id
str(base_nacidos_vivos_2019_menor15)

nacidosvivos_2019_menor15_suma <-base_nacidos_vivos_2019_menor15 %>%
  group_by(jurisdiccion_de_residencia_id) %>%
  dplyr::summarise(casos=sum(nacimientos_cantidad))

nacidosvivos_2019_15a19_suma <-base_nacidos_vivos_2019_15a19 %>%
  group_by(jurisdiccion_de_residencia_id) %>%
  dplyr::summarise(casos=sum(nacimientos_cantidad))

nacidosvivos_2019_20a24_suma <-base_nacidos_vivos_2019_20a24 %>%
  group_by(jurisdiccion_de_residencia_id) %>%
  dplyr::summarise(casos=sum(nacimientos_cantidad))

nacidosvivos_2019_25a29_suma <-base_nacidos_vivos_2019_25a29 %>%
  group_by(jurisdiccion_de_residencia_id) %>%
  dplyr::summarise(casos=sum(nacimientos_cantidad))

###AÑO 2020

base_nacidos_vivos_2020_menor15 <- base_nacidos_vivos_2020 %>%
  filter(edad_madre_grupo == "1.Menor de 15")

unique(base_nacidos_vivos_2019_menor15$edad_madre_grupo)
  
base_nacidos_vivos_2020_15a19 <- base_nacidos_vivos_2020 %>%
  filter(edad_madre_grupo == "2.15 a 19")
  
base_nacidos_vivos_2020_20a24 <- base_nacidos_vivos_2020 %>%
  filter(edad_madre_grupo == "3.20 a 24")
  
base_nacidos_vivos_2020_25a29 <- base_nacidos_vivos_2020 %>%
  filter(edad_madre_grupo == "4.25 a 29")

  
nacidosvivos_2020_menor15_suma <-base_nacidos_vivos_2020_menor15 %>%
  group_by(jurisdicion_residencia_nombre) %>%
  dplyr::summarise(casos=sum(nacimientos_cantidad))

nacidosvivos_2020_15a19_suma <-base_nacidos_vivos_2020_15a19 %>%
  group_by(jurisdicion_residencia_nombre) %>%
  dplyr::summarise(casos=sum(nacimientos_cantidad))

nacidosvivos_2020_20a24_suma <-base_nacidos_vivos_2020_20a24 %>%
  group_by(jurisdicion_residencia_nombre) %>%
  dplyr::summarise(casos=sum(nacimientos_cantidad))

nacidosvivos_2020_25a29_suma <-base_nacidos_vivos_2020_25a29 %>%
  group_by(jurisdicion_residencia_nombre) %>%
  dplyr::summarise(casos=sum(nacimientos_cantidad))

#replico con id

nacidosvivos_2020_menor15_suma <-base_nacidos_vivos_2020_menor15 %>%
  group_by(jurisdiccion_de_residencia_id) %>%
  dplyr::summarise(casos=sum(nacimientos_cantidad))

nacidosvivos_2020_15a19_suma <-base_nacidos_vivos_2020_15a19 %>%
  group_by(jurisdiccion_de_residencia_id) %>%
  dplyr::summarise(casos=sum(nacimientos_cantidad))

nacidosvivos_2020_20a24_suma <-base_nacidos_vivos_2020_20a24 %>%
  group_by(jurisdiccion_de_residencia_id) %>%
  dplyr::summarise(casos=sum(nacimientos_cantidad))

nacidosvivos_2020_25a29_suma <-base_nacidos_vivos_2020_25a29 %>%
  group_by(jurisdiccion_de_residencia_id) %>%
  dplyr::summarise(casos=sum(nacimientos_cantidad))

```

2) Se procesan las proyecciones poblacionales de madres (considerando sexo=femenino) para cada grupo etario

```{r proyecciones poblacionales madres, , echo=TRUE}
base_proyecciones <- read.csv2("poblacion indec gamma.csv", encoding="latin1", sep = ",")
#use doc de proyecciones gamma

str(base_proyecciones)
head(base_proyecciones)

base_proyecciones_fem <- base_proyecciones %>%
  filter(Sexo == "2")

#se puede generar el denominador de menores de 15, pero evaluar cuáles seleccionar

base_proyecciones_fem_2019 <- base_proyecciones_fem %>%
  filter(Ano == "2019")

base_proyecciones_fem_2020 <- base_proyecciones_fem %>%
  filter(Ano == "2020")


##AÑO 2019
str(base_proyecciones_fem_2019)

proyecciones_2019_menor15 <- base_proyecciones_fem_2019 %>%
  select(CodProv, X10.14)

proyecciones_2019_15a19 <- base_proyecciones_fem_2019 %>%
  select(CodProv, X15.19)

proyecciones_2019_20a24 <- base_proyecciones_fem_2019 %>%
  select(CodProv, X20.24)

proyecciones_2019_25a29 <- base_proyecciones_fem_2019 %>%
  select(CodProv, X25.29)

##AÑO 2020

str(base_proyecciones_fem_2020)
proyecciones_2020_menor15 <- base_proyecciones_fem_2020 %>%
  select(CodProv, X10.14)

proyecciones_2020_15a19 <- base_proyecciones_fem_2020 %>%
  select(CodProv, X15.19)

proyecciones_2020_20a24 <- base_proyecciones_fem_2020 %>%
  select(CodProv, X20.24)

proyecciones_2020_25a29 <- base_proyecciones_fem_2020 %>%
  select(CodProv, X25.29)
```
3) Se calculan las tasas dividiendo el número de nacimientos para cada rango etario por las proyecciones poblacionales de ese rango etario, por factor de expansión 10.000

```{r fecundidad adolescente, , echo=TRUE}

##AÑO 2019
base_tfa_2019_menores15 <- left_join(nacidosvivos_2019_menor15_suma, proyecciones_2019_menor15, 
              by = c("jurisdiccion_de_residencia_id" = "CodProv"))

base_tfa_2019_menores15_final <- base_tfa_2019_menores15 %>%
  mutate(tfa_2019_menores15 = casos/X10.14*10000)


base_tfa_2019_15a19 <- left_join(nacidosvivos_2019_15a19_suma, proyecciones_2019_15a19, 
              by = c("jurisdiccion_de_residencia_id" = "CodProv"))

base_tfa_2019_15a19_final <- base_tfa_2019_15a19 %>%
  mutate(tfa_2019_15a19 = casos/X15.19*10000)



base_tfa_2019_20a24 <- left_join(nacidosvivos_2019_20a24_suma, proyecciones_2019_20a24, 
              by = c("jurisdiccion_de_residencia_id" = "CodProv"))

base_tfa_2019_20a24_final <- base_tfa_2019_20a24 %>%
  mutate(tfa_2019_20a24 = casos/X20.24*10000)




base_tfa_2019_25a29 <- left_join(nacidosvivos_2019_25a29_suma, proyecciones_2019_25a29, 
              by = c("jurisdiccion_de_residencia_id" = "CodProv"))

base_tfa_2019_25a29_final <- base_tfa_2019_25a29 %>%
  mutate(tfa_2019_25a29 = casos/X25.29*10000)

#junto las 4

bases_tfa_2019_completa <- (list(base_tfa_2019_menores15_final, base_tfa_2019_15a19_final, base_tfa_2019_20a24_final, base_tfa_2019_25a29_final) %>% reduce(left_join, by='jurisdiccion_de_residencia_id'))

write_xlsx(bases_tfa_2019_completa,"bases_tfa_2019_completa.xlsx")

##AÑO 2020
base_tfa_2020_menores15 <- left_join(nacidosvivos_2020_menor15_suma, proyecciones_2020_menor15, 
              by = c("jurisdiccion_de_residencia_id" = "CodProv"))

base_tfa_2020_menores15_final <- base_tfa_2020_menores15 %>%
  mutate(tfa_2020_menores15 = casos/X10.14*10000)



base_tfa_2020_15a19 <- left_join(nacidosvivos_2020_15a19_suma, proyecciones_2020_15a19, 
              by = c("jurisdiccion_de_residencia_id" = "CodProv"))

base_tfa_2020_15a19_final <- base_tfa_2020_15a19 %>%
  mutate(tfa2020_15a19 = casos/X15.19*10000)



base_tfa_2020_20a24 <- left_join(nacidosvivos_2020_20a24_suma, proyecciones_2020_20a24, 
              by = c("jurisdiccion_de_residencia_id" = "CodProv"))

base_tfa_2020_20a24_final <- base_tfa_2020_20a24 %>%
  mutate(tfa_2020_20a24 = casos/X20.24*10000)




base_tfa_2020_25a29 <- left_join(nacidosvivos_2020_25a29_suma, proyecciones_2020_25a29, 
              by = c("jurisdiccion_de_residencia_id" = "CodProv"))

base_tfa_2020_25a29_final <- base_tfa_2020_25a29 %>%
  mutate(tfa_2020_25a29 = casos/X25.29*10000)

bases_tfa_2020_completa <- (list(base_tfa_2020_menores15_final, base_tfa_2020_15a19_final, base_tfa_2020_20a24_final, base_tfa_2020_25a29_final) %>% 
                    reduce(left_join, by='jurisdiccion_de_residencia_id')) %>% 
  ### redondeo todas la numericas a 2 decimales
              mutate_at(vars(tfa_2020_menores15,
                 tfa2020_15a19,
                 tfa_2020_20a24,
                 tfa_2020_25a29), funs(round(., 1)))

datatable(select(bases_tfa_2020_completa, jurisdiccion_de_residencia_id,
                 tfa_2020_menores15,
                 tfa2020_15a19,
                 tfa_2020_20a24,
                 tfa_2020_25a29),
          filter = 'top',
          rownames=F,
          elementId = NULL,
          options = list(
  searching = FALSE,
  pageLength = 10,
  lengthMenu = c( 10, 24)
))# aca falta agregarle nombre a la provicnias y titulo a la tabla

write_xlsx(bases_tfa_2020_completa,"bases_tfa_2020_completa.xlsx")


```

# Mortalidad por causas externas indeterminadas

## Analisis descriptivo

```{r descriptivos mortalidad externas indeterminadas, echo=TRUE, fig.height=14, fig.width=14}
#traigo catalogo cie 10 con listas gbd

catalogo_CIE10 <- read_excel("Catalogo_CIE_completo.xls",
                       sheet = "CatalogoVolumen1", range ="A5:Y14423" )
str(catalogo_CIE10)

#catalogo_CIE10 <- catalogo_CIE10 %>%
#  rename(`Lista GBD  Grupos  (1,2, 3, 4)` = GBD)

cat_ext_maldef <- catalogo_CIE10 %>% 
  select(No, Clave, Nombre,  `Lista GBD  Grupos  (1,2, 3, 4)`) %>% 
  filter (`Lista GBD  Grupos  (1,2, 3, 4)` == 3 | `Lista GBD  Grupos  (1,2, 3, 4)` == 4 )

str(cat_ext_maldef)

#borrar el último número de Clave y traer por derecha a cod3

class(cat_ext_maldef$Clave)

cat_ext_maldef$Clave2 <- str_sub(cat_ext_maldef$Clave, 1, 3)

#traigo base msal con lista msal

base_mortalidad <- read.csv2("MINSAL-defunciones-2005-2020.csv", encoding="latin1", sep = ",")

#mirar variables
str(base_mortalidad)

unique(base_mortalidad$lista_clasificacion)
cod_lesiones <- c("113 EVENTOS DE INTENCION NO DETERMINADA", "110 OTROS ACCIDENTES", "112 AGRESIONES", "111 SUICIDIO", "116 SECUELAS DE CAUSAS EXTERNAS")

#cod_caidas <- c("107 CAIDAS ACCIDENTALES")
#cod_transito <- c("105 ACCIDENTES DE TRANSPORTE") 

#NO TENEMOS LOS GRUPOS ETARIOS QUE NECESITAMOS EN LA BASE DE MORTALIDAD

listas_arg <- base_mortalidad %>%
  filter (lista_clasificacion %in% cod_lesiones) %>% 
  select(lista_clasificacion, cie10_casusa_id) %>% 
  distinct(lista_clasificacion, cie10_casusa_id)

str(listas_arg)
unique(listas_arg$cie10_casusa_id)


juntas <- inner_join(
  cat_ext_maldef,
  listas_arg,
  by = c("Clave" = "cie10_casusa_id"),
  copy = FALSE,
  suffix = c(".x", ".y"),
  keep = FALSE
)

####BASE VP
base_mortalidad_VP <- read.csv2("def2019VP.csv", encoding="UTF-8", sep = ",")
str(base_mortalidad_VP)
unique(base_mortalidad_VP$codmuer)
unique(base_mortalidad_VP$grupedad)

###año 2019

base_VP_2019 <- base_mortalidad_VP %>%
  dplyr::filter (ano == "2019")

base_VP_2019$codmuer2 <- str_sub(base_VP_2019$codmuer, 1, 3)

mortalidad_2019 <-  inner_join(
  base_VP_2019,
  juntas,
  by = c("codmuer2" = "Clave"),
  copy = FALSE,
  suffix = c(".x", ".y"),
  keep = FALSE
)

#str(mortalidad_2019)
table(mortalidad_2019$lista_clasificacion)### los 11 de secuelas de causas externAS ESTAN MAL CODIFICADOS, LO DEBERIAMOS PASAR A 113


#ACA HABIA UN ERROR EN EL CALCULO DEL % NO DABA BIEN,,,
prueba2 <- mortalidad_2019 %>% 
  group_by(grupedad, lista_clasificacion)%>%
  dplyr::summarise(total = n()) %>% 
  #group_by(grupedad) %>% ESOT LO CAMBIE, PORQ QUEEMOS VER DISTRIBUNIO DE CADA CAUSA DENTOR DEL GRUPO DE EDAD
  group_by(lista_clasificacion) %>%
  mutate( porc = total/sum(total))

prueba_sexo <- mortalidad_2019 %>% 
  filter(sexo!=9) %>% 
  group_by(grupedad,sexo, lista_clasificacion)%>%
  dplyr::summarise(total = n()) %>% 
  group_by(sexo) %>% 
  mutate( porc = total/sum(total))
##
prueba <- mortalidad_2019 %>% 
  group_by(grupedad, lista_clasificacion)%>%
  dplyr::summarise(total = n()) %>% 
  group_by(grupedad) %>% 
  mutate( porc = total/sum(total))


plot_2019 <- ggplot(prueba, aes(grupedad, porc, colour = lista_clasificacion)) + 
  geom_point() +
  coord_flip()
##AL DE ARRIBA LO HARIA MEJOR COMO BARRAS APILADAS
plot_2019 <- ggplot(prueba, aes(grupedad, porc, fill = lista_clasificacion)) + 
geom_bar(position="fill", stat="identity")+
  coord_flip()

plot_2019 <- ggplot(prueba, aes(grupedad, total, fill = lista_clasificacion)) + 
geom_bar(position="stack", stat="identity")+
  coord_flip()

plot_2019

##otro plot sugerido
# SE PODRIA AGRUPAR MENORES DE UN AÑO PARA CADA GRAFICO

ggplot(prueba2, 
       aes(x = grupedad, y= porc, group = lista_clasificacion, fill = lista_clasificacion)) +
  geom_bar(stat="identity") + 
  facet_wrap(vars(lista_clasificacion), scales="free_x", ncol=2)  +
  guides(fill=FALSE) + theme_bw() +
  theme(strip.text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.title = element_blank(),
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 14)) 

ggplot(prueba_sexo, 
       aes(x = grupedad, y= total, fill = as.factor(sexo))) +
  geom_bar(stat = "identity", position = "stack") + 
  facet_wrap(~lista_clasificacion, ncol = 2 )  +
  theme_bw() +
  theme(strip.text = element_text(size = 14),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.title = element_blank(),
        axis.text = element_text(size = 14),
        axis.title = element_text(size = 14)) 


```

### Descriptivo de causas externas de mortalidad en niños y adolescentes

```{r descriptivo mortalidad en nya, echo=TRUE}
#filtro para grupo 10-29

str(mortalidad_2019)
unique(mortalidad_2019$grupedad)
nya <- c("12.25 a 29", "11.20 a 24", "09.10 a 14", "10.15 a 19")
sex <- c("1", "2")

mort_nya <- mortalidad_2019 %>% 
  filter(grupedad %in% nya & sexo %in% sex) %>% 
  group_by(grupedad, sexo, lista_clasificacion)%>%
  dplyr::summarise(total = n()) %>% 
  ungroup() %>% 
  group_by(grupedad) %>% 
  mutate( porc = total/sum(total))

plot_nya_2019 <- ggplot(mort_nya, aes(grupedad, porc, colour = lista_clasificacion)) + 
  geom_point() +
  coord_flip()
plot_nya_2019

##ver de mejorar estos graficos
##separo por sexo

#con facet grid
plot_nya_2019 <- ggplot(mort_nya, aes(grupedad, porc, colour = lista_clasificacion)) + 
  geom_point() +
  facet_grid(~sexo)+
  coord_flip()
plot_nya_2019
#con render

#install.packages("viridis")
library(viridis)
#install.packages("gganimate")
library(gganimate)
#install.packages("magick")
library(magick)


graf_animado <- ggplot(mort_nya, aes(grupedad, porc, colour = lista_clasificacion)) +
  geom_point(size=5) +
  coord_flip() +
  scale_color_viridis(option = "mako", discrete = T, direction = -1)+
  theme_bw() +
  labs(caption = '{closest_state}', x = 'Casos confirmados', y = 'casos fallecidos', col="Grupo de edad:") +
  theme(text = element_text(colour = "#3D1308"),
        plot.caption = element_text(size = 14))  +
  transition_states(sexo,state_length=50)+
  #ease_aes('elastic-in')+
  shadow_wake(wake_length = 0.5,exclude_layer = 2)+
  guides(
  fill = guide_legend(
    override.aes = aes(label = "")
  )
)

graf_animado <- animate(graf_animado, renderer = magick_renderer())

```

## Mortalidad por agresiones en adolescentes
- Se calcula como número de muertes por agresiones entre 10 y 29 años. / población proyectada a mitad de periodo de 10 a 29 años , mismo año y provincia (evaluar dividir 10-19 y 20-29)
- Indicador para año 2019
```{r indicadores mortalidad nya, echo=TRUE}

#recorte de proyecciones por edad y sexo

base_proyecciones <- read.csv2("poblacion indec gamma.csv", encoding="latin1", sep = ",")
#use doc de proyecciones gamma
str(base_proyecciones)

base_proyecciones_2019_nya <- base_proyecciones %>%
  filter(Ano == "2019") %>% 
  select(CodProv, Sexo, X10.14, X15.19, X20.24, X25.29)

str(base_proyecciones_2019_nya)

agrup_base_proyecciones_2019_nya <- base_proyecciones_2019_nya %>%
  rowwise() %>% 
  mutate("10_19" = sum(c(X10.14, X15.19))) %>% 
  mutate("20_29" = sum(c(X20.24, X25.29))) %>% 
  mutate(tot = sum(c(X10.14, X15.19, X20.24, X25.29)))

agrup_base_proyecciones_2019_nya_juntos <- agrup_base_proyecciones_2019_nya %>% 
  pivot_wider(names_from = Sexo, values_from = c(X10.14, X15.19, X20.24, X25.29, `10_19`, `20_29`, tot))
  
total_nya <- agrup_base_proyecciones_2019_nya_juntos %>% 
  rowwise() %>% 
  mutate("total" = sum(c(tot_1, tot_2))) %>% 
  select(CodProv, total)

#base mortalidad

str(mortalidad_2019)
unique(mortalidad_2019$grupedad)
nya <- c("12.25 a 29", "11.20 a 24", "09.10 a 14", "10.15 a 19")
sex <- c("1", "2")

mort_nya <- mortalidad_2019 %>% 
  filter(grupedad %in% nya & sexo %in% sex) %>% 
  group_by(juri, grupedad, sexo, lista_clasificacion)%>%
  dplyr::summarise(total = n()) 

#tomamos por un lado agresiones y por otro lado suicidios
mort_nya_suicidios <- mort_nya %>% 
  filter(lista_clasificacion == "111 SUICIDIO") %>% 
  group_by(juri) %>% 
  summarise(tot_suicidios= sum(total))#agregre el tot

mort_nya_agresiones <- mort_nya %>% 
  filter(lista_clasificacion == "112 AGRESIONES") %>% 
  group_by(juri) %>% 
  summarise(tot_agresiones=sum(total))

ind_mortalidad_suicidios <- left_join(mort_nya_suicidios, total_nya, 
              by = c("juri" = "CodProv")) %>% 
  mutate(ind = round(tot_suicidios/total* 100000,2))#corregí y agregue factor de expansion

ind_mortalidad_agresiones <- left_join(mort_nya_agresiones, total_nya, 
              by = c("juri" = "CodProv")) %>% 
  mutate(ind = round(tot_agresiones/total* 100000,2))

##aca armar tablas con datatable con los dos indicadores en una misma tabla


###revise hasta aca (velen)

#write_xlsx(ind_mortalidad_suicidios,"ind_mortalidad_suicidios.xlsx")
#write_xlsx(ind_mortalidad_agresiones,"ind_mortalidad_agresiones.xlsx")



```

```{r mortalidad diabetes tipo 2 - descriptivo, echo=TRUE}

base_mortalidad <- read.csv2("MINSAL-defunciones-2005-2020.csv", encoding="latin1", sep = ",")
str(base_mortalidad)
unique(base_mortalidad$lista_clasificacion)

#cod diabetes tipo 2: 053, pero no diferencia tipo 1 o 2

base_diabetes_2019 <- base_mortalidad %>%
  filter (lista_clasificacion == "053 DIABETES MELLITUS" & anio == "2019")

unique(base_mortalidad$grupo_edad)
base_diabetes_2019_adultos <- base_diabetes_2019 %>%
  filter (grupo_edad   == "10.75 y más" | grupo_edad == "09.65 a 74" | grupo_edad == "07.45 a 54" | grupo_edad == "06.35 a 44" | grupo_edad == "08.55 a 64" | grupo_edad == "05.25 a 34")

unique(base_diabetes_2019$cie10_casusa_id)

#hay E10 E11 E12 E13 E14

des_diabetes_2019 <- base_diabetes_2019_adultos %>%
  group_by(jurisdicion_residencia_nombre, cie10_casusa_id, grupo_edad, sexo_id) %>%
  dplyr::summarise(casos=sum(cantidad))

des_diabetes_2019_bis <- base_diabetes_2019_adultos %>%
  group_by(cie10_casusa_id, grupo_edad, sexo_id) %>%
  dplyr::summarise(casos=sum(cantidad))


plot  <- des_diabetes_2019_bis %>%
  ggplot(aes(x = cie10_casusa_id,
             y = casos,
             color = sexo_id)) +
  geom_boxplot()

#  facet_grid(jurisdicion_residencia_nombre ~ .)

                                                                                   
```

